import { debounce} from '../common.js'
import { status, json, queryParams } from '../http-helpers.js'

<search-authority class="relative" type={ opts.type }>
	<input class="search" oninput={ doSearch } type="search"/>
	<div if={ query !== "" } class={ caret: true, open: gotResults }></div>

	<style scoped>
		input { width: 95%;  }
		.caret { position: absolute; top: 0.25em; right: 0.25em; }
	</style>

	<script>
		const tag = this
		const debounceMs = 400

		tag.query = ""
		tag.gotResults = false
		tag.searching = false
		tag.results = []

		let debouncedSearch = debounce(
			function(query) {
				tag.searching = true
				tag.gotResults = false
				tag.update()
				fetch(`/services/search/${tag.opts.type}/_search?q=${query}`)
					.then(status)
					.then(json)
					.then(function(data) {
						tag.searching = false
						tag.gotResults = (data.hits.total > 0)
						tag.opts.events.trigger('searchResults', data.hits.hits)
						tag.update()
					})
					.catch(function (error) {
						console.log('request failed', error)
					})
			}, debounceMs)

		tag.doSearch = function(event) {
			let query = event.target.value.trim()
			if (query === "") {
				return
			}
			debouncedSearch(query)
		}
	</script>
</search-authority>