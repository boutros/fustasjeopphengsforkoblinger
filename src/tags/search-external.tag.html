import { debounce } from '../common.js'
import { status, json, queryParams } from '../http-helpers.js'
import { marc2rdf } from '../marc.js'
import state from '../state.js'
import suggestionmixin from '../suggestionmixin.js'

import './search-external-results.tag.html'

<search-external>
	<table>
		<tbody>
			<tr>
				<td><strong>ISBN</strong></td>
				<td><strong>Forfatter</strong></td>
				<td><strong>Tittel</strong></td>
			</tr>
			<tr>
				<td><input type="search" name="isbn"/></td>
				<td><input type="search" name="author" /></td>
				<td><input type="search" name="title"/></td>
			</tr>
	</table>

	<div>
		<button name="bibbi" disabled={ resultSelected || results.bibbi.searching } onclick={ search }>Biblioteksentralen</button>
		<button name="loc" disabled={ resultSelected || results.loc.searching } onclick={ search }>Library Of Congress</button>
		<br/>
	</div>

	<search-external-results results={ this.results }></search-external-results>

	<style scoped>
		table { width: 100%; }
		input[type="search"] { width: 7.5em; }
		buttonÂ { margin: 1em 1em 1em 0; padding: 0.5em; }
	</style>

	<script>
		const tag = this
		const debounceMs = 400

		let initialResults = {
			bibbi: {
				searching: false,
				preview: undefined,
				records: undefined
			},
			loc: {
				searching: false,
				preview: undefined,
				records: undefined
			}
		}

		tag.results = initialResults

		// true if any of the search results have been selected
		tag.resultSelected = false

		// store inserted triples from marc record, in case we want to delete them again
		tag.insertedTriples = []

		tag.mixin(suggestionmixin)


		tag.events = riot.observable()
		tag.events.on('selected', function(marc, base) {
			tag.update({resultSelected: true})
			let {graph, suggestions} = marc2rdf(marc, state.centerNode, state.ns)
			for (let triple of graph.triples()) {
				// TODO should first delete any triples allready filled out in the form..
				state.db.insert(triple)
			}
			tag.insertedTriples = graph.triples()
			for (let s of suggestions) {
				switch (base) {
					case 'bibbi':
						s.source = 'bs'
						break
					default:
						s.source = base
				}
				tag.searchSuggestionEvents.trigger('suggestion', s)
			}
		})
		tag.events.on('unselected', function() {
			for (let triple of tag.insertedTriples) {
				state.db.delete(triple)
			}
			tag.update({resultSelected: false})
		})

		let debounceSearch = debounce(function(base, isbn, author, title) {
			if (isbn === "" && author === "" && title === "") {
				return
			}
			let params = {
				base: base
			}
			if (author !== "") {
				params.author = author
			}
			if (title !== "") {
				params.title = title
			}
			if (isbn !== "") {
				params.isbn = isbn
			}

			tag.results[base].searching = true
			tag.results[base].previews = undefined
			tag.results[base].records = undefined
			tag.update()

			fetch('/search/z3950'+queryParams(params))
				.then(status)
				.then(json)
				.then(function(data) {
					tag.events.trigger('got-results')
					tag.results[base].previews = data.previews
					tag.results[base].records = data.marc
					tag.results[base].searching = false
					tag.update()
				})
				.catch(function (error) {
					console.log('request failed', error)
				})
		}, debounceMs)

		tag.search = function(event) {
			debounceSearch(event.target.name, tag.isbn.value, tag.author.value, tag.title.value)
			return true
		}
	</script>
</search-external>